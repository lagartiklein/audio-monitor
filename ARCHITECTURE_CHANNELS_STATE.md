# ğŸ”„ Diagrama del Sistema de Persistencia de Canales

## Arquitectura General

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CLIENTE WEB                                 â”‚
â”‚  (Navegador - http://localhost:8080)                                â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ UI Interactiva                                               â”‚   â”‚
â”‚  â”‚ - Faders (Ganancia)                                          â”‚   â”‚
â”‚  â”‚ - Controles de Pan                                           â”‚   â”‚
â”‚  â”‚ - Botones de Canal (Activo/Inactivo)                        â”‚   â”‚
â”‚  â”‚ - Mute/Solo                                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                 â”‚                                    â”‚
â”‚                                 â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ WebSocket Eventos                                            â”‚   â”‚
â”‚  â”‚ - update_gain({channel, gain})                              â”‚   â”‚
â”‚  â”‚ - update_pan({channel, pan})                                â”‚   â”‚
â”‚  â”‚ - toggle_mute({channel, muted})                             â”‚   â”‚
â”‚  â”‚ - subscribe({channels, gains, pans})                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    WebSocket (Socket.IO)   â”‚
                    â”‚  Puerto 8080/5000          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       SERVIDOR FLASK/PYTHON                           â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ WebSocket Handlers (websocket_server.py)                    â”‚    â”‚
â”‚  â”‚                                                              â”‚    â”‚
â”‚  â”‚ handle_update_gain()        â”                               â”‚    â”‚
â”‚  â”‚   â†“                          â”‚                               â”‚    â”‚
â”‚  â”‚ channel_manager.update()     â”‚ Cada uno llama:              â”‚    â”‚
â”‚  â”‚   â†“                          â”‚ _save_client_config_to_       â”‚    â”‚
â”‚  â”‚ _save_client_config_to_      â”‚   registry()                 â”‚    â”‚
â”‚  â”‚   registry()                 â”‚                               â”‚    â”‚
â”‚  â”‚   â†“                          â”‚                               â”‚    â”‚
â”‚  â”‚ registry.update_channels_   â—„â”˜                               â”‚    â”‚
â”‚  â”‚   state()                                                    â”‚    â”‚
â”‚  â”‚                                                              â”‚    â”‚
â”‚  â”‚ handle_update_pan()          â”                               â”‚    â”‚
â”‚  â”‚ handle_toggle_mute()         â”œâ”€ Mismo flujo                 â”‚    â”‚
â”‚  â”‚ handle_update_client_mix()  â”˜                               â”‚    â”‚
â”‚  â”‚                                                              â”‚    â”‚
â”‚  â”‚ handle_subscribe()           (Si no hay canales, restaura)  â”‚    â”‚
â”‚  â”‚   â†“                                                          â”‚    â”‚
â”‚  â”‚ _restore_client_channels_state()                            â”‚    â”‚
â”‚  â”‚   â†“                                                          â”‚    â”‚
â”‚  â”‚ registry.get_channels_state(client_id)                      â”‚    â”‚
â”‚  â”‚                                                              â”‚    â”‚
â”‚  â”‚ handle_connect()             (Al conectar cliente)          â”‚    â”‚
â”‚  â”‚   â†“                                                          â”‚    â”‚
â”‚  â”‚ _restore_channels_state_on_startup()                        â”‚    â”‚
â”‚  â”‚   â†“                                                          â”‚    â”‚
â”‚  â”‚ registry.get_channels_state(None)  â† Todos                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                 â”‚                                    â”‚
â”‚                                 â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Device Registry (device_registry.py)                         â”‚    â”‚
â”‚  â”‚                                                              â”‚    â”‚
â”‚  â”‚ MÃ©todos principales:                                        â”‚    â”‚
â”‚  â”‚ - update_channels_state(client_id, state)                   â”‚    â”‚
â”‚  â”‚ - get_channels_state(client_id=None)                        â”‚    â”‚
â”‚  â”‚ - save_channels_state()  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚    â”‚
â”‚  â”‚ - load_channels_state()  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚             â”‚    â”‚
â”‚  â”‚ - clear_channels_state(client_id)      â”‚      â”‚             â”‚    â”‚
â”‚  â”‚                                        â”‚      â”‚             â”‚    â”‚
â”‚  â”‚ Datos en memoria:                      â”‚      â”‚             â”‚    â”‚
â”‚  â”‚ self.channels_state = {                â”‚      â”‚             â”‚    â”‚
â”‚  â”‚   'client_id_1': {...},               â”‚      â”‚             â”‚    â”‚
â”‚  â”‚   'client_id_2': {...},               â”‚      â”‚             â”‚    â”‚
â”‚  â”‚   ...                                  â”‚      â”‚             â”‚    â”‚
â”‚  â”‚ }                                      â”‚      â”‚             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                 â”‚      â”‚                             â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                         â”‚                   â”‚                       â”‚
â”‚                  Lectura (RAM)        Lectura/Escritura (Disco)      â”‚
â”‚                         â”‚                   â”‚                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚                   â”‚
                          â–¼                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Archivo: config/channels_state.json       â”‚
                    â”‚                                  â”‚
                    â”‚ {                                â”‚
                    â”‚   "timestamp": 1704528000,       â”‚
                    â”‚   "channels_state": {            â”‚
                    â”‚     "client_id_1": {...},        â”‚
                    â”‚     "client_id_2": {...},        â”‚
                    â”‚     ...                          â”‚
                    â”‚   }                              â”‚
                    â”‚ }                                â”‚
                    â”‚                                  â”‚
                    â”‚ âœ… Persistencia en disco         â”‚
                    â”‚ âœ… Survives reinicio del servidor
                    â”‚ âœ… Una copia por cliente         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Flujo: Usuario Cambia Ganancia

```
Cliente Web                 Servidor                    Disco
    â”‚                          â”‚                         â”‚
    â”‚â”€ update_gain() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                         â”‚
    â”‚                          â”‚                         â”‚
    â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
    â”‚                 â”‚ handle_update_    â”‚              â”‚
    â”‚                 â”‚   gain()          â”‚              â”‚
    â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
    â”‚                          â”‚                         â”‚
    â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
    â”‚              â”‚ channel_manager.         â”‚          â”‚
    â”‚              â”‚ update_client_mix()      â”‚          â”‚
    â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
    â”‚                          â”‚                         â”‚
    â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
    â”‚              â”‚ _save_client_config_    â”‚          â”‚
    â”‚              â”‚ to_registry()            â”‚          â”‚
    â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
    â”‚                          â”‚                         â”‚
    â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
    â”‚              â”‚ registry.                â”‚          â”‚
    â”‚              â”‚ update_channels_state() â”‚          â”‚
    â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
    â”‚                          â”‚                         â”‚
    â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
    â”‚                  â”‚ Actualiza      â”‚               â”‚
    â”‚                  â”‚ self.channels_ â”‚               â”‚
    â”‚                  â”‚ state en RAM   â”‚               â”‚
    â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
    â”‚                          â”‚                         â”‚
    â”‚â—€â”€ gain_updated â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                        â”‚
    â”‚ (respuesta inmediata)     â”‚                        â”‚
    â”‚                          â”‚                        â”‚
    â”‚                    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
    â”‚                    â”‚ Thread async: â”‚              â”‚
    â”‚                    â”‚ save_channels_â”‚              â”‚
    â”‚                    â”‚ state()       â”‚              â”‚
    â”‚                    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
    â”‚                          â”‚                        â”‚
    â”‚                          â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
    â”‚                          â”‚      â”‚ Escribir    â”‚   â”‚
    â”‚                          â”‚      â”‚ channels_   â”‚â”€â”€â”€â–¶â”‚
    â”‚                          â”‚      â”‚ state.json  â”‚    â”‚
    â”‚                          â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â”‚                          â”‚                        â”‚
    â”‚â—€â”€ param_sync (broadcast)â”€                        â”‚
    â”‚ (Otros clientes)         â”‚                        â”‚
```

---

## Flujo: Reiniciar Servidor

```
Cliente 1              Servidor              Disco
    â”‚                    â”‚                    â”‚
    â”‚                    â”‚                    â”‚
  [Apagado]          [Apagado]            [Guardado:
                                          channels_
                                          state.json]
    â”‚                    â”‚                    â”‚
    â”‚                    â”‚                    â”‚
  [Reiniciando]    init_server()             â”‚
    â”‚                    â”‚                    â”‚
    â”‚                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”
    â”‚                    â”‚   â”‚ load_channels_    â”‚
    â”‚                    â”‚   â”‚ state()           â”‚
    â”‚                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”
    â”‚                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”
    â”‚                    â”‚   â”‚ _restore_channels_â”‚
    â”‚                    â”‚   â”‚ state_on_startup()â”‚
    â”‚                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”
    â”‚                    â”‚                   â”‚  â”‚
    â”‚                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”
    â”‚                    â”‚  â”‚ Lee channels_     â”‚
    â”‚                    â”‚  â”‚ state.json        â”‚
    â”‚                    â”‚  â”‚ Restaura config   â”‚
    â”‚                    â”‚  â”‚ para cada cliente â”‚
    â”‚                    â”‚  â”‚ [Logs]            â”‚
    â”‚                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    â”‚                    â”‚
    â”‚                    â”‚   [Servidor Listo] â”‚
    â”‚                    â”‚                    â”‚
    â”‚â”€â”€â”€â”€â”€ connect() â”€â”€â”€â–¶â”‚                    â”‚
    â”‚                    â”‚                    â”‚
    â”‚                    â”‚  â”Œâ”€ handle_connectâ”‚
    â”‚                    â”‚  â”‚ handle_subscribeâ”‚
    â”‚                    â”‚  â”‚   â”‚              â”‚
    â”‚                    â”‚  â”‚   â”œâ”€ Sin canales â”‚
    â”‚                    â”‚  â”‚   â”‚              â”‚
    â”‚                    â”‚  â”‚   â”œâ”€_restore_    â”‚
    â”‚                    â”‚  â”‚   â”‚ client_      â”‚
    â”‚                    â”‚  â”‚   â”‚ channels_    â”‚
    â”‚                    â”‚  â”‚   â”‚ state()      â”‚
    â”‚                    â”‚  â”‚   â”‚              â”‚
    â”‚                    â”‚  â”‚   â”œâ”€ Restaura   â”‚
    â”‚                    â”‚  â”‚   â”‚ [Ch0, Ch1]  â”‚
    â”‚                    â”‚  â”‚   â”‚ [Gain 0.8]  â”‚
    â”‚â—€â”€ auto_resubscribedâ”‚  â”‚   â”‚ [Pan -0.5]  â”‚
    â”‚ [Mi config]        â”‚  â”‚   â”‚              â”‚
    â”‚                    â”‚  â””â”€â”€â”€â”              â”‚
    â”‚[Cliente ve        â”‚       â”‚              â”‚
    â”‚su config]         â”‚       â”‚              â”‚
```

---

## Flujo: MÃºltiples Clientes

```
Cliente A              Servidor             Cliente B              Disco
  â”‚                       â”‚                    â”‚                     â”‚
  â”‚â”€ subscribe([0,1]) â”€â”€â–¶ â”‚                    â”‚                     â”‚
  â”‚                   â”Œâ”€â”€â–¶ registry.update_    â”‚                     â”‚
  â”‚                   â”‚    channels_state()    â”‚                     â”‚
  â”‚                   â”‚   gain=0.8, pan=-0.5  â”‚                     â”‚
  â”‚                   â”‚                       â”‚                     â”‚
  â”‚â—€â”€ subscribed â”€â”€â”€â”€â”€â”˜    â”‚                    â”‚                     â”‚
  â”‚                        â”‚                   â”‚                     â”‚
  â”‚                        â”‚                   â”‚â”€ subscribe([2,3,4])â–¶â”‚
  â”‚                        â”‚                   â”‚                     â”‚
  â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                     â”‚
  â”‚                    â”‚   registry.update_    â”‚                     â”‚
  â”‚                    â”‚   channels_state()    â”‚                     â”‚
  â”‚                    â”‚   gain=0.9            â”‚                     â”‚
  â”‚                    â”‚                       â”‚                     â”‚
  â”‚                    â”‚               â—€â”€â”€â”€â”€â”€â”€â”€â”€                     â”‚
  â”‚                    â”‚               subscribed                   â”‚
  â”‚                    â”‚                       â”‚                     â”‚
  â”‚  [Cliente A emite]â”‚                        â”‚                     â”‚
  â”‚â”€ update_gain(0.7) â”€â”€â–¶â”‚                     â”‚                     â”‚
  â”‚                   â”‚                       â”‚                     â”‚
  â”‚                   â”œâ”€ update_channels_state("A", {...})          â”‚
  â”‚                   â”‚                       â”‚                     â”‚
  â”‚                   â”œâ”€ broadcast_clients_update()                 â”‚
  â”‚                   â”‚                       â”‚                     â”‚
  â”‚â—€â”€ gain_updated â”€â”€â”€â”˜                        â”‚                     â”‚
  â”‚                                           â”‚                     â”‚
  â”‚                   param_sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶                    â”‚
  â”‚                   (Notificar a Cliente B)  â”‚                     â”‚
  â”‚                                           â”‚                     â”‚
  â”‚                  [Guardado async]        â–¶â”‚
  â”‚                   â”œâ”€ channels_state.json  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
  â”‚                   â”‚ {                     â”‚ â”‚ "A": {          â”‚â”‚
  â”‚                   â”‚   "A": {...},         â”‚ â”‚   channels:...  â”‚â”‚
  â”‚                   â”‚   "B": {...}          â”‚ â”‚   gains: 0.7... â”‚â”‚
  â”‚                   â”‚ }                     â”‚ â”‚ }               â”‚â”‚
  â”‚                   â”‚                       â”‚ â”‚ "B": {          â”‚â”‚
  â”‚                   â”‚                       â”‚ â”‚   channels:...  â”‚â”‚
  â”‚                   â”‚                       â”‚ â”‚   gains: 0.9... â”‚â”‚
  â”‚                   â”‚                       â”‚ â”‚ }               â”‚â”‚
  â”‚                   â”‚                       â”‚ â”‚                 â”‚â”‚
  â”‚                   â”‚                       â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
  â”‚                   â”‚                       â”‚                     â”‚
  â”‚ (DespuÃ©s) Client B sin cambios             â”‚  En disco:          â”‚
  â”‚ pero Cliente A cambiÃ³                      â”‚  Cada uno tiene     â”‚
  â”‚                                            â”‚  su config          â”‚
```

---

## Estructura de Datos en Memoria

```python
# En device_registry.channels_state:
{
    "web-abc123": {
        "channels": [0, 1, 2],           # QuÃ© canales estÃ¡ escuchando
        "gains": {
            "0": 1.0,                    # Ganancia canal 0
            "1": 0.8,                    # Ganancia canal 1
            "2": 0.9                     # Ganancia canal 2
        },
        "pans": {
            "0": 0.0,                    # Pan canal 0 (center)
            "1": -0.5,                   # Pan canal 1 (izquierda)
            "2": 0.25                    # Pan canal 2 (derecha)
        },
        "mutes": {
            "0": False,
            "1": False,
            "2": True                    # Canal 2 silenciado
        },
        "master_gain": 1.0,              # Ganancia maestra del cliente
        "timestamp": 1704528000000       # CuÃ¡ndo se guardÃ³
    },
    
    "web-def456": {
        "channels": [3, 4, 5, 6, 7],
        "gains": {...},
        "pans": {...},
        "mutes": {...},
        "master_gain": 0.8,
        "timestamp": 1704528001000
    }
}
```

---

## Thread Safety

```
Thread 1                 Thread 2              Thread 3
(WebSocket)            (Guardado)            (Lectura)
    â”‚                      â”‚                      â”‚
    â”‚â”€â”€ Update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
    â”‚  en RAM             â”‚                      â”‚
    â”‚                 â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
    â”‚                 â”‚ Lock adquirido â”‚          â”‚
    â”‚                 â”‚ (escribir JSON)â”‚          â”‚
    â”‚                 â”‚ Lock liberado  â”‚          â”‚
    â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
    â”‚                                            â”‚
    â”‚â—€â”€ Lectura sin lock (cachÃ© en RAM) â—€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
    â”‚                                            â”‚
  [Seguro porque:]
  1. channels_state_lock (RLock) protege escritura
  2. Lectura es siempre desde cachÃ© en RAM
  3. Guardado a disco es asincrÃ³nico en thread daemon
  4. No hay race conditions en operaciones crÃ­ticas
```

---

## Timing

```
Usuario interactÃºa (Ganancia 0.8)
    â”‚
    â–¼
   ~0ms â”€â”€â”€â”€â”€â”€â”€ Cambio recibido por servidor
    â”‚
    â–¼
   ~5ms â”€â”€â”€â”€â”€â”€â”€ Actualizar channel_manager
    â”‚
    â–¼
  ~10ms â”€â”€â”€â”€â”€â”€â”€ Respuesta enviada al cliente
    â”‚
    â–¼
  ~50ms â”€â”€â”€â”€â”€â”€â”€ Estado guardado en RAM
    â”‚
    â–¼
 ~100ms â”€â”€â”€â”€â”€â”€â”€ Escritura en disco (async)
    â”‚
    â–¼
 ~150ms â”€â”€â”€â”€â”€â”€â”€ sync_param a otros clientes
    â”‚
 [El usuario nunca ve latencia - todo es fluido]
```

---

## Resumen del Flujo

1. **Usuario en Web**: Mueve fader, hace clic
2. **WebSocket**: Emite evento (update_gain, update_pan, etc)
3. **Servidor**: Handler actualiza channel_manager
4. **Respuesta inmediata**: Cliente recibe confirmaciÃ³n ~10ms
5. **Guardado**: update_channels_state() y save_channels_state()
6. **Archivo**: channels_state.json se actualiza (~100ms async)
7. **Broadcast**: Otros clientes reciben cambio
8. **Persistencia**: Si se apaga el servidor, todo estÃ¡ en disco
9. **Reinicio**: Restaura automÃ¡ticamente para todos
10. **Nuevo cliente**: Restaura automÃ¡ticamente su estado anterior

---

## Guarantees

âœ… **Durabilidad**: Cambios se guardan en disco
âœ… **Consistencia**: Thread-safe en todas las operaciones
âœ… **Disponibilidad**: No bloquea operaciones de usuario
âœ… **Recuperabilidad**: Se restaura automÃ¡ticamente en reinicio
âœ… **Aislamiento**: Cada cliente tiene su propio estado
âœ… **Performance**: Guardado asincrÃ³nico, sin latencia perceptible
