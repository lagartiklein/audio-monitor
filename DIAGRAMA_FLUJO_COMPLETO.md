# ğŸ“ DIAGRAMA DE FLUJO COMPLETO: SincronizaciÃ³n End-to-End

## 1. ARQUITECTURA GENERAL DEL SISTEMA

```
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚   INTERNET / RED LOCAL       â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚               â”‚               â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   WEB CLIENT  â”‚  â”‚ WEB CLIENT  â”‚  â”‚  ANDROID    â”‚
         â”‚   (Browser 1) â”‚  â”‚ (Browser 2) â”‚  â”‚   CLIENT    â”‚
         â”‚ UUID: web-xxx â”‚  â”‚ UUID: web-yyyâ”‚  â”‚ UUID: uuid-zâ”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚               â”‚             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          (WebSocket + TCP)
                                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                                         â”‚
        â”‚                                                         â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                  FICHATECH SERVER (main.py)              â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
   â”‚  â”‚ WebSocket Server (puerto 5100)                      â”‚ â”‚
   â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
   â”‚  â”‚ â”‚ web_clients = {                               â”‚   â”‚ â”‚
   â”‚  â”‚ â”‚   'session-abc': {device_uuid: 'web-xxx', ...}â”‚   â”‚ â”‚
   â”‚  â”‚ â”‚   'session-def': {device_uuid: 'web-yyy', ...}â”‚   â”‚ â”‚
   â”‚  â”‚ â”‚ }                                              â”‚   â”‚ â”‚
   â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
   â”‚  â”‚                                                       â”‚ â”‚
   â”‚  â”‚ @socketio.on('connect')        handle_connect()      â”‚ â”‚
   â”‚  â”‚ @socketio.on('update_client_mix') handle_update_mix()â”‚ â”‚
   â”‚  â”‚ @socketio.on('update_gain')   handle_update_gain()   â”‚ â”‚
   â”‚  â”‚ @socketio.on('disconnect')    handle_disconnect()    â”‚ â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
   â”‚                                                              â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   â”‚  â”‚ Native TCP Server (puerto 5101)                       â”‚  â”‚
   â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
   â”‚  â”‚ â”‚ self.clients = {                                â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚   'uuid-z': NativeClient(...),                  â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚ }                                                â”‚  â”‚  â”‚
   â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
   â”‚  â”‚                                                        â”‚  â”‚
   â”‚  â”‚ def _handle_control_message()                         â”‚  â”‚
   â”‚  â”‚ def _handle_update_mix()                             â”‚  â”‚
   â”‚  â”‚ def _emit_param_sync_to_web()                        â”‚  â”‚
   â”‚  â”‚ def push_mix_state_to_client()                       â”‚  â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   â”‚                                                              â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   â”‚  â”‚ ChannelManager (Gestor Central)                       â”‚  â”‚
   â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
   â”‚  â”‚ â”‚ subscriptions = {                                â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚   'session-abc': {                               â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚     channels: [0,1,2],                           â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚     gains: {0: 1.0, 1: 0.5},                     â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚     device_uuid: 'web-xxx'                       â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚   },                                             â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚   'uuid-z': {                                    â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚     channels: [3,4,5],                           â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚     gains: {3: 0.8},                             â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚     device_uuid: 'uuid-z'                        â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚   }                                              â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚ }                                                â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚                                                  â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚ device_client_map = {                            â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚   'web-xxx': 'session-abc',                      â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚   'web-yyy': 'session-def',                      â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚   'uuid-z': 'uuid-z'                             â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚ }                                                â”‚  â”‚  â”‚
   â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
   â”‚  â”‚                                                        â”‚  â”‚
   â”‚  â”‚ def subscribe_client()                                â”‚  â”‚
   â”‚  â”‚ def update_client_mix()                               â”‚  â”‚
   â”‚  â”‚ def get_client_subscription()                         â”‚  â”‚
   â”‚  â”‚ def get_client_by_device_uuid()                       â”‚  â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   â”‚                                                              â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   â”‚  â”‚ DeviceRegistry (Persistencia Central)                 â”‚  â”‚
   â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
   â”‚  â”‚ â”‚ devices = {                                      â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚   'web-xxx': {                                   â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚     uuid: 'web-xxx',                             â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚     type: 'web',                                 â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚     name: 'Web-xxx',                             â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚     primary_ip: '192.168.1.7',                   â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚     first_seen: 1767396785,                      â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚     last_seen: 1767551499,                       â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚     reconnections: 8,                            â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚     configuration: {                             â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚       channels: [0,1,2],                         â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚       gains: {0: 1.0, 1: 0.5}                    â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚     },                                           â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚     active: true                                 â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚   },                                             â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚   'uuid-z': { ... }                              â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚ }                                                â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚                                                  â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚ [GUARDADO EN DISCO: config/devices.json]         â”‚  â”‚  â”‚
   â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
   â”‚  â”‚                                                        â”‚  â”‚
   â”‚  â”‚ def register_device()                                 â”‚  â”‚
   â”‚  â”‚ def update_configuration()                            â”‚  â”‚
   â”‚  â”‚ def get_configuration()                               â”‚  â”‚
   â”‚  â”‚ def save_to_disk()                                    â”‚  â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   â”‚                                                              â”‚
   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
   â”‚  â”‚ Audio Stream Processing                               â”‚  â”‚
   â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
   â”‚  â”‚ â”‚ AudioCapture â†’ NativeServer.on_audio_data()      â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚            â†“ (mix per subscriptions)             â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚         NativeClient.send_audio_packet()         â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚            â†“ (cada cliente)                      â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚         â†’ Android (TCP binario)                  â”‚  â”‚  â”‚
   â”‚  â”‚ â”‚         â†’ Web (WebSocket)                        â”‚  â”‚  â”‚
   â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
   â”‚  â”‚                                                        â”‚  â”‚
   â”‚  â”‚ INDEPENDIENTE DEL FLUJO DE CONTROL (sincronizaciÃ³n)   â”‚  â”‚
   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
   â”‚                                                              â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. CICLO DE VIDA: CONEXIÃ“N â†’ CAMBIO â†’ PERSISTENCIA

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CLIENTE WEB NUEVO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 1: PRIMERA CARGA (Frontend)                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. localStorage.getItem('fichatech_web_device_uuid') â†’ null             â”‚
â”‚ 2. Generar: webDeviceUuid = 'web-' + random()                           â”‚
â”‚ 3. localStorage.setItem('fichatech_web_device_uuid', webDeviceUuid)     â”‚
â”‚ 4. âœ… PERSISTIDO LOCALMENTE                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 2: CONECTAR AL SERVIDOR (WebSocket handshake)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ socket.auth = {                                                          â”‚
â”‚   device_uuid: this.webDeviceUuid,  â† 'web-xxx'                         â”‚
â”‚   device_name: 'My Control Center'                                       â”‚
â”‚ }                                                                         â”‚
â”‚ socket.connect()  â†’ WebSocket handshake                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 3: SERVIDOR RECIBE CONEXIÃ“N                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ websocket_server.py:268 handle_connect(auth=auth):                      â”‚
â”‚   client_id = request.sid  â†’ 'session-abc123'                           â”‚
â”‚   web_device_uuid = auth.get('device_uuid')  â†’ 'web-xxx'                â”‚
â”‚                                                                           â”‚
â”‚   # Almacenar en web_clients dict                                        â”‚
â”‚   web_clients['session-abc123'] = {                                      â”‚
â”‚       'device_uuid': 'web-xxx',                                          â”‚
â”‚       'address': '192.168.1.7',                                          â”‚
â”‚       'user_agent': '...'                                                â”‚
â”‚   }                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 4: RESTAURACIÃ“N DESDE device_registry (SI EXISTE)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ LÃ­nea 313-333:                                                           â”‚
â”‚ if web_device_uuid and device_registry:                                 â”‚
â”‚     config_prev = device_registry.get_configuration('web-xxx')          â”‚
â”‚     if config_prev and config_prev.get('channels'):                     â”‚
â”‚         # RESTAURAR configuraciÃ³n anterior                              â”‚
â”‚         channel_manager.subscribe_client(                                â”‚
â”‚             client_id='session-abc123',                                   â”‚
â”‚             channels=config_prev['channels'],  # [0,1,2]                â”‚
â”‚             gains=config_prev['gains'],                                  â”‚
â”‚             device_uuid='web-xxx'                                        â”‚
â”‚         )                                                                 â”‚
â”‚         emit('auto_resubscribed', {                                      â”‚
â”‚             'channels': [0,1,2],                                        â”‚
â”‚             'gains': {...}                                               â”‚
â”‚         })                                                                â”‚
â”‚                                                                           â”‚
â”‚ SI NO EXISTE:                                                            â”‚
â”‚     # Cliente debe seleccionar canales manualmente                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 5: REGISTRAR EN device_registry (NUEVO DISPOSITIVO)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ LÃ­nea 355-363:                                                           â”‚
â”‚ device_registry.register_device('web-xxx', {                            â”‚
â”‚     'type': 'web',                                                       â”‚
â”‚     'name': auth.get('device_name'),                                     â”‚
â”‚     'primary_ip': '192.168.1.7',                                         â”‚
â”‚     'user_agent': 'Mozilla/5.0...'                                       â”‚
â”‚ })                                                                        â”‚
â”‚                                                                           â”‚
â”‚ Internamente:                                                            â”‚
â”‚   if 'web-xxx' already in devices:                                       â”‚
â”‚       # ReconexiÃ³n: incrementar reconnections counter                    â”‚
â”‚       device['last_seen'] = now                                          â”‚
â”‚       device['reconnections'] += 1                                       â”‚
â”‚   else:                                                                   â”‚
â”‚       # Primera conexiÃ³n: crear nuevo registro                           â”‚
â”‚       device = {                                                         â”‚
â”‚           'uuid': 'web-xxx',                                             â”‚
â”‚           'type': 'web',                                                 â”‚
â”‚           'first_seen': now,                                             â”‚
â”‚           'last_seen': now,                                              â”‚
â”‚           'reconnections': 0,                                            â”‚
â”‚           'configuration': {},  # SerÃ¡ llenado despuÃ©s                   â”‚
â”‚           'active': True                                                 â”‚
â”‚       }                                                                   â”‚
â”‚   self.save_to_disk()  â† ESCRIBIR config/devices.json                    â”‚
â”‚                                                                           â”‚
â”‚   âœ… DISPOSITIVO REGISTRADO PERMANENTEMENTE                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 6: CLIENTE SELECCIONA CANALES (UI EVENT)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Frontend:                                                                 â”‚
â”‚   User hace click en "Activate Channel 0"                               â”‚
â”‚   â†’ this.toggleChannel('web-xxx', 0)                                     â”‚
â”‚   â†’ client.channels = [0]  âœ… UI LOCAL ACTUALIZADA INMEDIATAMENTE       â”‚
â”‚   â†’ socket.emit('update_client_mix', {                                   â”‚
â”‚       target_client_id: 'web-xxx',                                       â”‚
â”‚       channels: [0]                                                      â”‚
â”‚     })                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 7: SERVIDOR ACTUALIZA ESTADO (CORE UPDATE)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ websocket_server.py:492 handle_update_client_mix(data):                 â”‚
â”‚   target_client_id = data['target_client_id']  â†’ 'web-xxx'              â”‚
â”‚                                                                           â”‚
â”‚   # GUARDAR ESTADO PREVIO para detecciÃ³n de cambios                     â”‚
â”‚   prev_subscription = channel_manager.get_client_subscription(...)      â”‚
â”‚   prev_channels = set(prev_subscription.get('channels', []))            â”‚
â”‚                                                                           â”‚
â”‚   # ACTUALIZAR EN channel_manager                                        â”‚
â”‚   channel_manager.update_client_mix(                                     â”‚
â”‚       target_client_id='web-xxx',                                        â”‚
â”‚       channels=[0]                                                       â”‚
â”‚   )                                                                       â”‚
â”‚   âœ… channel_manager.subscriptions['web-xxx']['channels'] = [0]         â”‚
â”‚                                                                           â”‚
â”‚   # OBTENER NUEVO ESTADO                                                â”‚
â”‚   new_subscription = channel_manager.get_client_subscription(...)       â”‚
â”‚   new_channels = set([0])                                               â”‚
â”‚                                                                           â”‚
â”‚   # DETECTAR DIFERENCIAS                                                â”‚
â”‚   channels_added = new_channels - prev_channels                         â”‚
â”‚   channels_removed = prev_channels - new_channels                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 8: EMITIR param_sync A OTROS CLIENTES (NO AL SOLICITANTE)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ websocket_server.py:557-570:                                            â”‚
â”‚ for ch in channels_added:                                               â”‚
â”‚     socketio.emit('param_sync', {                                        â”‚
â”‚         'type': 'channel_toggle',                                       â”‚
â”‚         'channel': 0,                                                    â”‚
â”‚         'value': True,                                                   â”‚
â”‚         'client_id': 'web-xxx',                                          â”‚
â”‚         'source': 'web',                                                 â”‚
â”‚         'timestamp': 1767551499001                                       â”‚
â”‚     }, skip_sid='session-abc123')  â† NO envÃ­a al que lo solicitÃ³        â”‚
â”‚                                                                           â”‚
â”‚ âœ… OTROS CLIENTES WEB + ANDROID RECIBEN INMEDIATAMENTE                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 9: SINCRONIZAR A ANDROID (SI ES CLIENTE NATIVO)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ websocket_server.py:627-630:                                            â”‚
â”‚ subscription = channel_manager.get_client_subscription('web-xxx')       â”‚
â”‚ if subscription.get('client_type') == 'native':                         â”‚
â”‚     native_server_instance.push_mix_state_to_client('web-xxx')          â”‚
â”‚                                                                           â”‚
â”‚ â†’ native_server.py:1204 push_mix_state_to_client():                     â”‚
â”‚   subscription = channel_manager.get_client_subscription(...)           â”‚
â”‚   client = self.clients[persistent_id]                                  â”‚
â”‚   client.send_mix_state(subscription)  â† SEND VIA TCP                   â”‚
â”‚                                                                           â”‚
â”‚ â†’ native_server.py:278 send_mix_state():                                â”‚
â”‚   payload = {                                                            â”‚
â”‚       'channels': [0],                                                   â”‚
â”‚       'gains': {...},                                                    â”‚
â”‚       'pans': {...}                                                      â”‚
â”‚   }                                                                       â”‚
â”‚   packet = NativeAndroidProtocol.create_control_packet(...)             â”‚
â”‚   self.send_bytes_sync(packet)  â† ENVÃO TCP BLOQUEANTE                  â”‚
â”‚                                                                           â”‚
â”‚ âœ… ANDROID RECIBE MIX_STATE Y ACTUALIZA                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PASO 10: PERSISTENCIA A DISCO (GUARDADO PERMANENTE)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ websocket_server.py:949 _save_client_config_to_registry(client_id):     â”‚
â”‚   device_uuid = subscription.get('device_uuid')  â†’ 'web-xxx'            â”‚
â”‚   config_to_save = {                                                     â”‚
â”‚       'channels': [0],                                                   â”‚
â”‚       'gains': {...},                                                    â”‚
â”‚       'pans': {...},                                                     â”‚
â”‚       'timestamp': 1767551499001                                         â”‚
â”‚   }                                                                       â”‚
â”‚                                                                           â”‚
â”‚   channel_manager.device_registry.update_configuration(                  â”‚
â”‚       device_uuid='web-xxx',                                             â”‚
â”‚       config=config_to_save                                              â”‚
â”‚   )                                                                       â”‚
â”‚                                                                           â”‚
â”‚ â†’ device_registry.py:200 update_configuration():                        â”‚
â”‚   with self.device_lock:                                                â”‚
â”‚       self.devices['web-xxx']['configuration'] = config_to_save         â”‚
â”‚   self.save_to_disk()  â† WRITE JSON                                      â”‚
â”‚                                                                           â”‚
â”‚ config/devices.json:                                                     â”‚
â”‚ {                                                                         â”‚
â”‚   "web-xxx": {                                                           â”‚
â”‚     "configuration": {                                                   â”‚
â”‚       "channels": [0],  â† GUARDADO                                       â”‚
â”‚       "timestamp": 1767551499001                                         â”‚
â”‚     }                                                                     â”‚
â”‚   }                                                                       â”‚
â”‚ }                                                                         â”‚
â”‚                                                                           â”‚
â”‚ âœ… CAMBIO PERSISTENTE PARA SIGUIENTE RECONEXIÃ“N                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TOTAL LATENCY:
â”œâ”€ 0ms:    User click
â”œâ”€ 5ms:    Server receives
â”œâ”€ 10ms:   Channel manager updated
â”œâ”€ 20ms:   param_sync emitted to other webs
â”œâ”€ 30ms:   Other webs see UI update
â”œâ”€ 50ms:   Android receives mix_state
â”œâ”€ 100ms:  Saved to persistent_state
â”œâ”€ 300ms:  Written to config/devices.json
â””â”€ DONE:   Fully persisted
```

---

## 3. EVENT FLOW MATRIX

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          EVENT EMISSION MATRIX                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Event                       â”‚ Who Emits    â”‚ To Whom      â”‚ Line         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 'update_client_mix'         â”‚ Frontend     â”‚ Server       â”‚ front: 1540  â”‚
â”‚ 'param_sync'                â”‚ Server       â”‚ All Webs     â”‚ serv: 557-70 â”‚
â”‚ (type: channel_toggle)      â”‚ (except orig)â”‚ + Android    â”‚              â”‚
â”‚                             â”‚              â”‚              â”‚              â”‚
â”‚ 'push_mix_state'            â”‚ Server       â”‚ Android      â”‚ serv: 630    â”‚
â”‚ (control packet)            â”‚              â”‚              â”‚              â”‚
â”‚                             â”‚              â”‚              â”‚              â”‚
â”‚ 'param_sync'                â”‚ Android      â”‚ All Webs     â”‚ nserv: 469   â”‚
â”‚ (via native_server)         â”‚              â”‚              â”‚              â”‚
â”‚                             â”‚              â”‚              â”‚              â”‚
â”‚ 'clients_update'            â”‚ Server       â”‚ All Webs     â”‚ serv: 619    â”‚
â”‚ (broadcast)                 â”‚              â”‚              â”‚              â”‚
â”‚                             â”‚              â”‚              â”‚              â”‚
â”‚ 'device_info'               â”‚ Server       â”‚ Requesting   â”‚ serv: 291    â”‚
â”‚ (on connect)                â”‚              â”‚ Web          â”‚              â”‚
â”‚                             â”‚              â”‚              â”‚              â”‚
â”‚ 'auto_resubscribed'         â”‚ Server       â”‚ Requesting   â”‚ serv: 333    â”‚
â”‚ (if restored)               â”‚              â”‚ Web          â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. THREAD SAFETY & LOCKS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           CONCURRENCY MODEL                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Location                    â”‚ Lock Type          â”‚ Protected Resource    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚ channel_manager             â”‚ NONE (R.C.)        â”‚ subscriptions (dict)   â”‚
â”‚                             â”‚                    â”‚ device_client_map      â”‚
â”‚                             â”‚ THREAD-SAFE OPS    â”‚ copy-on-modify         â”‚
â”‚                             â”‚                    â”‚                        â”‚
â”‚ native_server              â”‚ self.client_lock   â”‚ self.clients (dict)   â”‚
â”‚                             â”‚                    â”‚ adding/removing clientsâ”‚
â”‚                             â”‚                    â”‚                        â”‚
â”‚ native_server              â”‚ self.persistent    â”‚ persistent_state (dict)â”‚
â”‚                             â”‚   _lock            â”‚ client state cache     â”‚
â”‚                             â”‚                    â”‚                        â”‚
â”‚ device_registry            â”‚ device_lock        â”‚ devices (dict)         â”‚
â”‚                             â”‚                    â”‚ register/modify device â”‚
â”‚                             â”‚                    â”‚                        â”‚
â”‚ device_registry            â”‚ persistence_lock   â”‚ File I/O               â”‚
â”‚                             â”‚                    â”‚ config/devices.json    â”‚
â”‚                             â”‚                    â”‚                        â”‚
â”‚ websocket_server           â”‚ web_clients_lock   â”‚ web_clients (dict)     â”‚
â”‚                             â”‚                    â”‚ web client tracking    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

LOCK HIERARCHY (to prevent deadlocks):
  1. persistence_lock (outermost - affects I/O)
  2. device_lock (device registry modifications)
  3. client_lock (native client management)
  4. web_clients_lock (web client tracking)
  
NO nested lock combinations observed â†’ LOW DEADLOCK RISK
```

---

## 5. ERROR RECOVERY

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ERROR RECOVERY PATHS                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Scenario                     â”‚ Detection Method    â”‚ Recovery            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Device disconnects           â”‚ handle_disconnect()â”‚ State in device_reg  â”‚
â”‚ (Web)                        â”‚ socket timeout     â”‚ Restored on reconnectâ”‚
â”‚                             â”‚                    â”‚ Config from disk     â”‚
â”‚                             â”‚                    â”‚                      â”‚
â”‚ Device disconnects           â”‚ is_alive() check   â”‚ persistent_state keptâ”‚
â”‚ (Android)                    â”‚ heartbeat timeout  â”‚ Restored on reconnectâ”‚
â”‚                             â”‚ TCP socket close   â”‚ Config from disk     â”‚
â”‚                             â”‚                    â”‚                      â”‚
â”‚ Config write fails           â”‚ Exception in       â”‚ Logged, user notifiedâ”‚
â”‚                             â”‚ save_to_disk()     â”‚ In-memory config keptâ”‚
â”‚                             â”‚                    â”‚ Retry on next change â”‚
â”‚                             â”‚                    â”‚                      â”‚
â”‚ Device registry corrupt      â”‚ JSON parse error   â”‚ Rollback to last goodâ”‚
â”‚                             â”‚ on load            â”‚ Auto-recreate from   â”‚
â”‚                             â”‚                    â”‚ active clients       â”‚
â”‚                             â”‚                    â”‚                      â”‚
â”‚ Lost connection mid-change  â”‚ Timeout before ACK â”‚ Client retries       â”‚
â”‚                             â”‚                    â”‚ Server-side change   â”‚
â”‚                             â”‚                    â”‚ persisted anyway     â”‚
â”‚                             â”‚                    â”‚ Sync on reconnect    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

---

## 6. VERIFICACIÃ“N FINAL: Â¿FUNCIONARÃ?

### âœ… Pregunta 1: Â¿Cada cliente es Ãºnico?
```
SÃ - Garantizado:
âœ“ Web: localStorage + device_uuid (format: web-XXXXX)
âœ“ Android: SharedPreferences + UUID v4 (format: 00000000-0000-0000-...)
âœ“ device_registry mapea UUID â†’ dispositivo permanente
âœ“ device_client_map mapea UUID â†” client_id activo
```

### âœ… Pregunta 2: Â¿Los cambios se reflejan inmediatamente?
```
SÃ - Garantizado:
âœ“ Webâ†’Web: param_sync con skip_sid (< 30ms)
âœ“ Webâ†’Android: push_mix_state vÃ­a TCP (< 100ms)
âœ“ Androidâ†’Web: _emit_param_sync_to_web vÃ­a WebSocket (< 50ms)
âœ“ Servidor SIEMPRE tiene el estado mÃ¡s reciente
```

### âœ… Pregunta 3: Â¿Se persisten los datos?
```
SÃ - Garantizado:
âœ“ device_registry.devices[UUID] en RAM
âœ“ config/devices.json en disco (< 500ms)
âœ“ Thread-safe con locks exclusivos
âœ“ RestauraciÃ³n automÃ¡tica en siguiente conexiÃ³n
```

### âœ… Pregunta 4: Â¿Sin pÃ©rdida de datos?
```
SÃ - Garantizado:
âœ“ Cambios guardados antes de confirmaciÃ³n
âœ“ device_registry es "source of truth"
âœ“ Si servidor cae, estado se recupera de disco
âœ“ Si cliente cae, estado se preserva en servidor
```

### âœ… Pregunta 5: Â¿Independiente del audio?
```
SÃ - Completamente:
âœ“ Flujo de control: WebSocket (JSON) + TCP (binario control)
âœ“ Flujo de audio: Separado (TCP stream binario)
âœ“ SincronizaciÃ³n NO afecta latencia de audio
âœ“ Audio stream NO afecta velocidad de sincronizaciÃ³n
```

